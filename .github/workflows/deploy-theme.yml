name: Deploy WP themes & plugins to GCP VM

on:
  push:
    branches: [ "main" ]
    paths:
      - "themes/**"
      - "plugins/**"
      - ".github/workflows/deploy-wp.yml"
      - ".rsyncignore"
  workflow_dispatch: {}

env:
  REMOTE_PATH: ${{ secrets.REMOTE_PATH }}   # /var/www/wordpress
  WP_CLI_PATH: ${{ secrets.WP_CLI_PATH }}   # /var/www/wordpress

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # (Tuỳ chọn) Build assets nếu có package.json trong theme/plugin
      - name: Build theme/plugin assets (optional)
        if: hashFiles('themes/**/package.json', 'plugins/**/package.json') != ''
        run: |
          set -e
          corepack enable || true
          npm -v || (sudo apt-get update && sudo apt-get install -y npm)
          for PKG in $(git ls-files "themes/**/package.json" "plugins/**/package.json"); do
            DIR=$(dirname "$PKG")
            echo "== Build in $DIR =="
            (cd "$DIR" && npm ci || npm install && npm run build || true)
          done

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Ensure remote dirs exist
        run: |
          ssh -p ${{ secrets.SSH_PORT }} -i ~/.ssh/id_ed25519 ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "mkdir -p '${{ env.REMOTE_PATH }}/wp-content/themes' '${{ env.REMOTE_PATH }}/wp-content/plugins'"

      - name: Rsync THEMES (if present)
        if: hashFiles('themes/**') != ''
        run: |
          set -e
          RSYNC_EXCLUDES=""
          [ -f ".rsyncignore" ] && RSYNC_EXCLUDES="--exclude-from=.rsyncignore"
          rsync -az --delete \
            -e "ssh -p ${{ secrets.SSH_PORT }} -i ~/.ssh/id_ed25519" \
            $RSYNC_EXCLUDES \
            themes/ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ env.REMOTE_PATH }}/wp-content/themes/

      - name: Rsync PLUGINS (if present)
        if: hashFiles('plugins/**') != ''
        run: |
          set -e
          RSYNC_EXCLUDES=""
          [ -f ".rsyncignore" ] && RSYNC_EXCLUDES="--exclude-from=.rsyncignore"
          rsync -az --delete \
            -e "ssh -p ${{ secrets.SSH_PORT }} -i ~/.ssh/id_ed25519" \
            $RSYNC_EXCLUDES \
            plugins/ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ env.REMOTE_PATH }}/wp-content/plugins/

      - name: Put site in maintenance mode
        continue-on-error: true
        run: |
          ssh -p ${{ secrets.SSH_PORT }} -i ~/.ssh/id_ed25519 ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "cd '${{ env.WP_CLI_PATH }}' && wp maintenance-mode activate --allow-root || true"

      - name: Post-deploy tasks (flush cache & permalinks)
        continue-on-error: true
        run: |
          ssh -p ${{ secrets.SSH_PORT }} -i ~/.ssh/id_ed25519 ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} <<'EOF'
          set -e
          cd "${WP_CLI_PATH:-${REMOTE_PATH}}"
          wp cache flush --allow-root || true
          wp rewrite flush --hard --allow-root || true
          EOF

      - name: Disable maintenance mode
        continue-on-error: true
        run: |
          ssh -p ${{ secrets.SSH_PORT }} -i ~/.ssh/id_ed25519 ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "cd '${{ env.WP_CLI_PATH }}' && wp maintenance-mode deactivate --allow-root || true"

      - name: Fix permissions (optional)
        continue-on-error: true
        run: |
          ssh -p ${{ secrets.SSH_PORT }} -i ~/.ssh/id_ed25519 ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "sudo chown -R $USER:www-data '${{ env.REMOTE_PATH }}/wp-content' && sudo find '${{ env.REMOTE_PATH }}/wp-content' -type d -exec chmod 775 {} \; && sudo find '${{ env.REMOTE_PATH }}/wp-content' -type f -exec chmod 664 {} \; || true"
